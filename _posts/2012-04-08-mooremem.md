---
layout: post
title: "Moore Memory Consumption"
category: cern
---

* export CMTCONFIG=x86_64-slc5-gcc46-opt
* SetupProject Moore v13r2p5 
* I use [google profiling auditor](gpa) from Gaudi package.
* I've run profiling from 2000 to 10000 events.
* I've a lot of error messages like: 
   * ERROR LoKi::L0Filter:: LHCb::L0DUReportObject is invalid, return 'false'


## Preliminary results
* Every 100 events memory consumption increases by 1 to 2 Mb, but it increases constantly.
* All the memory consumption increased in the following functions:
   1. **boost::pool::malloc_need_resize**
   1. **std::vector::_M_insert_aux**
   
   I don't know **(yet)** who calls this functions.



## How to use profiler
* Run (use your option file with Google auditor):

  ```
  $> LD_PRELOAD=/afs/cern.ch/sw/lcg/external/tcmalloc/1.7p1/x86_64-slc5-gcc46-opt/lib/libtcmalloc_and_profiler.so gaudirun.py ~/leak/moore.py | tee log.txt
  ```
  
  

* Analyze (use your dump file):

  ```
  pprof --text `which python` FULL-Events7001To12001.0068.heap
  ```


## Option file
<script src="https://gist.github.com/2336910.js?file=moore.py"></script>



[gpa]: http://svnweb.cern.ch/world/wsvn/gaudi/Gaudi/trunk/GaudiProfiling/src/component/google/?#a6816e93c9669c650c04ee6b66730f067

---
layout: post
title: "Moore Memory Consumption"
category: cern
---

# 10.04.2012

## Top Memory Usage by Function Plot
* Moore v13r2p5
* CMTCONFIG=x86_64-slc5-gcc46-dbg
* Start profiling after **5000** events, stop at **10000** events. Total memory usage counter at 5000 events == 0.
* Dump the memory usage data each 1Gb memory allocation/deallocation cycle. Totaly I have **63** dumps.
* At the each dump analyze a total memory usage and select **top** 3 functions for the plot.
* At the plot below x-axis is a dump number and y-axis is memory usage (Mb). 
* If needed, it' possible to build a call chain graph for each function.
* [Full version of the plot][chart]

<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/spreadsheet/tq?key=0Ag1zWDlANxEodFBBYnZJeWFCRk5FZFBMeURJUmlBbFE&transpose=0&headers=1&range=A1%3AM64&gid=0&pub=1","options":{"fontName":"Comic Sans MS","legendTextStyle":{"color":"#222","fontSize":"9"},"animation":{"duration":500},"vAxis":{"format":"0.##"},"width":640,"logScale":false,"hAxis":{"title":"dump #"},"vAxes":[{"title":"Mb","viewWindowMode":"pretty","viewWindow":{"max":500},"maxValue":500},{"viewWindowMode":"pretty","viewWindow":{}}],"title":"Top Memory Usage by function","useFormatFromData":true,"booleanRole":"certainty","height":700,"useFirstColumnAsDomain":true,"isStacked":false},"state":{},"chartType":"AreaChart","chartName":"Chart 1"} </script>

[chart]: http://goo.gl/Zy6Fc


# 09.04.2012

* export CMTCONFIG=x86_64-slc5-gcc46-opt
* SetupProject Moore v13r2p5 
* I use [google profiling auditor](gpa) from Gaudi package.
* I've run profiling from 5000 to 10000 events.
* I've a lot of error messages like: 
   * ERROR LoKi::L0Filter:: LHCb::L0DUReportObject is invalid, return 'false'


## Results

### After 5000 events

<img src="https://lh4.googleusercontent.com/-t_kuPazy7CE/T4J_ndgMnLI/AAAAAAAADmg/W5EN1H0yzy0/s640/Selection_038.png"/>

### After 10000 events:

<img src="https://lh5.googleusercontent.com/-BBcLrbTmpEI/T4J_na1FdbI/AAAAAAAADmk/aCv9oHVrUUs/s640/Selection_039.png"/>

### Call chain

<a href="https://picasaweb.google.com/lh/photo/Qp_xKqQnOcTqvTNc_Gq9WtMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-tqzlpUE-jwU/T4J_neYjxTI/AAAAAAAADmo/fii2sBFiWok/s640/Selection_037.png" height="640" width="580" /></a>

[Full version (pdf)][callchain]

[callchain]: http://f.cl.ly/items/041o2I0V13341f243c0y/mem.pdf


# 08.04.2012

## Preliminary results
* Every 100 events memory consumption increases by 1 to 2 Mb, but it increases constantly.
* All the memory consumption increased in the following functions:
   1. **boost::pool::malloc_need_resize**
   1. **std::vector::_M_insert_aux**
   
   I don't know **(yet)** who calls this functions.



## How to use profiler
* Run (use your option file with Google auditor):

  ```
  $> LD_PRELOAD=/afs/cern.ch/sw/lcg/external/tcmalloc/1.7p1/x86_64-slc5-gcc46-opt/lib/libtcmalloc_and_profiler.so gaudirun.py ~/leak/moore.py | tee log.txt
  ```
  
  

* Analyze (use your dump file):

  ```
  pprof --text `which python` FULL-Events7001To12001.0068.heap
  ```


## Option file
<script src="https://gist.github.com/2336910.js?file=moore.py"></script>



[gpa]: http://svnweb.cern.ch/world/wsvn/gaudi/Gaudi/trunk/GaudiProfiling/src/component/google/?#a6816e93c9669c650c04ee6b66730f067
